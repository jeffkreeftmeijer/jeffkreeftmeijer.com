<!doctype html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="keywords" content="jeff kreeftmeijer, jeffkreeftmeijer" />
  <meta name="description" content="After letting my Node.js and web sockets experiment run for a week, I decided to improve the code a bit." />
  <title>
    
      Things I learned from my Node.js experiment
      
    
  </title>
  <style>body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,form,fieldset,input,textarea,p,blockquote,th,td{margin:0;padding:0}table{border-collapse:collapse;border-spacing:0}fieldset,img{border:0}address,caption,cite,code,dfn,em,strong,th,var{font-style:normal;font-weight:normal}ol,ul{list-style:none}caption,th{text-align:left}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:normal}q:before,q:after{content:''}abbr,acronym{border:0}#ads{position:absolute;width:425px;max-width:50%;left:50%;top:145px;margin:auto;overflow:hidden;z-index:0}.ad{margin:0 0 20px 295px;width:130px;font-size:11px;line-height:1.2}.ad a{color:#888;font-weight:500}div.influads_powered_div{margin-top:5px}a.influads_text_a{font-size:11px}a.influads_powered_link{font-size:10px}div.carbonad{background-color:#fff;border:0}.carbonad-image,.carbonad-text,.carbonad-tag{margin-left:0 !important}.carbonad-image{margin-top:0 !important}pre{padding:1em;line-height:100%;overflow:scroll}code{font-family:"Menlo",monospace;font-size:12px}.highlight{color:#586e75}.highlight .c{color:#93a1a1}.highlight .err{color:#586e75}.highlight .g{color:#586e75}.highlight .k{color:#859900}.highlight .l{color:#586e75}.highlight .n{color:#586e75}.highlight .o{color:#859900}.highlight .x{color:#cb4b16}.highlight .p{color:#586e75}.highlight .cm{color:#93a1a1}.highlight .cp{color:#859900}.highlight .c1{color:#93a1a1}.highlight .cs{color:#859900}.highlight .gd{color:#2aa198}.highlight .ge{color:#586e75;font-style:italic}.highlight .gr{color:#dc322f}.highlight .gh{color:#cb4b16}.highlight .gi{color:#859900}.highlight .go{color:#586e75}.highlight .gp{color:#586e75}.highlight .gs{color:#586e75;font-weight:bold}.highlight .gu{color:#cb4b16}.highlight .gt{color:#586e75}.highlight .kc{color:#cb4b16}.highlight .kd{color:#268bd2}.highlight .kn{color:#859900}.highlight .kp{color:#859900}.highlight .kr{color:#268bd2}.highlight .kt{color:#dc322f}.highlight .ld{color:#586e75}.highlight .m{color:#2aa198}.highlight .s{color:#2aa198}.highlight .na{color:#586e75}.highlight .nb{color:#b58900}.highlight .nc{color:#268bd2}.highlight .no{color:#cb4b16}.highlight .nd{color:#268bd2}.highlight .ni{color:#cb4b16}.highlight .ne{color:#cb4b16}.highlight .nf{color:#268bd2}.highlight .nl{color:#586e75}.highlight .nn{color:#586e75}.highlight .nx{color:#586e75}.highlight .py{color:#586e75}.highlight .nt{color:#268bd2}.highlight .nv{color:#268bd2}.highlight .ow{color:#859900}.highlight .w{color:#586e75}.highlight .mf{color:#2aa198}.highlight .mh{color:#2aa198}.highlight .mi{color:#2aa198}.highlight .mo{color:#2aa198}.highlight .sb{color:#93a1a1}.highlight .sc{color:#2aa198}.highlight .sd{color:#586e75}.highlight .s2{color:#2aa198}.highlight .se{color:#cb4b16}.highlight .sh{color:#586e75}.highlight .si{color:#2aa198}.highlight .sx{color:#2aa198}.highlight .sr{color:#dc322f}.highlight .s1{color:#2aa198}.highlight .ss{color:#2aa198}.highlight .bp{color:#268bd2}.highlight .vc{color:#268bd2}.highlight .vg{color:#268bd2}.highlight .vi{color:#268bd2}.highlight .il{color:#2aa198}#container{max-width:550px;margin:50px auto;padding:0 10px;position:relative;z-index:1}.content{margin-top:-1em}h2{float:left}h1{clear:both}ul#menu{float:right;padding:10px 0 10px}ul#menu li{display:inline;margin-left:10px}ul#menu form{display:inline}ul.articles{list-style-type:none}ul.articles li,div.result{margin-bottom:30px}ul.articles p,div.result p{margin:0}p.more{margin-top:-20px}.content img{width:100%;-webkit-border-radius:5px}#loading{margin:auto;width:32px;height:32px;background-image:url('/images/loading.gif')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;src:local('Open Sans Bold'),local('OpenSans-Bold'),url('/OpenSans-Bold.woff') format('woff')}@font-face{font-family:'Intro';font-style:normal;font-weight:500;src:local('Intro'),local('Intro'),url('/Intro.woff') format('woff')}body{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:16px;line-height:150%;color:#2b2b2b}#menu{font-size:80%}a{color:#4b4b4b;text-decoration:none;font-weight:900}a:hover{color:#2b2b2b}h2 a,h2 a:hover{color:#fff;display:block;line-height:150%;background-color:#2b2b2b;padding:10px;font-size:80%;-webkit-border-radius:5px}h1{font-family:"Intro","Helvetica Neue",Helvetica,Arial,sans-serif;font-size:38px;line-height:100%;padding:50px 0;text-rendering:optimizeLegibility}h1,h1 a{font-weight:500}h1 a{color:#2b2b2b;border-bottom:3px solid #eee}h3{font-family:"Open sans","Helvetica Neue",Helvetica,Arial,sans-serif;font-size:140%;line-height:100%}h4{font-family:"Intro","Helvetica Neue",Helvetica,Arial,sans-serif;margin-bottom:10px}.date,.small,h4{color:#888;font-size:80%}p{margin:1em 0}a.anchor{padding-top:50px}em{font-style:italic}.info{display:none !important}</style>
  <link rel="alternate" type="application/atom+xml" href="/feed.xml" />
  <link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <link href="/images/icon.jpg" rel="apple-touch-icon" />
  <meta name="viewport" content="initial-scale=1, user-scalable=yes">
</head>
<body>
  <div id="container">
    <h2>
      <a class="" href="/">
        Jeff Kreeftmeijer
      </a>
    </h2>

    <ul id="menu">
      <li><a href="http://shorts.jeffkreeftmeijer.com">Shorts</a></li>
      <li><a href="/archive">Archive</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
    <h1>Things I learned from my Node.js experiment</h1>
    <span class="date">2010-08-03</span>

<div class="content">
  <p>Last week, I published an article about <a href="http://jeffkreeftmeijer.com/2010/experimenting-with-node-js">my very first experiment</a> with <a href="http://nodejs.org">Node.js</a>. Being completely new to the whole thing, I decided to create a simple demo with web sockets.</p>

<p>As you can read in last week&#8217;s article, I created a page that checks your mouse cursor&#8217;s location and sends it to the web socket. The web socket broadcasts your mouse location to every other user on the page, so everyone will see your cursor moving around. That means you will see everybody else&#8217;s cursor moving around on your screen as well.</p>

<p><object width="440" height="308"><br><param name="allowfullscreen" value="true">
<br><param name="allowscriptaccess" value="always">
<br><param name="movie" value="http://vimeo.com/moogaloop.swf?clip_id=13805413&amp;server=vimeo.com&amp;show_title=0&amp;show_byline=0&amp;show_portrait=0&amp;color=ff9933&amp;fullscreen=1">
<br><embed src="http://vimeo.com/moogaloop.swf?clip_id=13805413&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=1&amp;show_portrait=0&amp;color=ff9933&amp;fullscreen=1" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="440" height="308"></embed><br></object></p>

<p>After letting my experiment run for a week, I learned a lot and improved the code. In this article I&#8217;ll go over some things I learned and how I fixed some issues.</p>

<p>Oh, and I&#8217;ve updated <a href="http://gist.github.com/488562">the Gist</a>, in case you want to use the code.</p>

<h3>People love fancy tricks with web sockets</h3>

<p>After posting the article, it jumped to the <a href="http://news.ycombinator.com/item?id=1548321">Hacker News</a> front page within minutes and stayed there for over 26 hours, got <a href="http://tweetmeme.com/story/1782313910/experimenting-with-nodejs-jeff-kreeftmeijer">retweeted like crazy</a> and got featured on <a href="http://5by5.tv/devshow/17">episode #17 of the Dev show</a>.</p>

<p>A lot of people commented or sent me replies via twitter and it was fun to see how cursors chased each other around, felt the urge to <a href="http://twitter.com/jnunemaker/status/19599899506">hump</a> or <a href="http://twitter.com/evilhackerdude/status/19687401793">bang</a> other cursors, <a href="http://www.reddit.com/r/programming/comments/ctvtz/experimenting_with_nodejs/c0v8243">draw shapes</a>, or make sure nobody could read the text by constantly hovering over it.</p>

<p>Thanks for the enthusiasm everybody, it was a lot of fun.</p>

<h3>Node.js handled everything perfectly</h3>

<p>Since this was my first experiment with Node.js, I expected cursors to start moving slow and the server to eventually crash. Especially because of this unexpected stream of visitors.</p>

<p>I added a rate limit of forty milliseconds &#8212; <code>mousemove()</code> gets fired <em>a lot</em> when you move your mouse &#8212; to take some load off the server and I got <a href="http://god.rubyforge.org/">God</a> to monitor it all and restart the server if it crashed.</p>

<p>However, except for some mistakes I made which caused the server to crash when somebody injected some javascript, Node.js handled everything perfectly. On a 256 MB <span class="caps">VPS</span>. Amazing.</p>

<h3>You can fall back to flash</h3>

<p>I posted a big notice above my article telling everyone to use Safari or Chrome, since they have support for web sockets. I didn&#8217;t know you could fall back to flash at the time.</p>

<p>Right now, the example runs on <a href="http://twitter.com/rauchg" title="Guillermo Rauch">@rauchg</a>&#8216;s <a href="http://github.com/LearnBoost/Socket.IO-node">Socket.IO</a> instead of <a href="http://github.com/miksago/node-websocket-server">web-socket-server</a>, which automatically switches to flash when your browser doesn&#8217;t support web sockets.</p>

<p>When you do this for yourself, please start the server with <code>sudo</code>. I couldn&#8217;t get it to work properly and eventually got help from Guillermo himself in the #node.js <span class="caps">IRC</span> channel.</p>

<p>The <a href="http://jeffkreeftmeijer.com/2010/experimenting-with-node-js/">demo</a> is still online, if you want to take it for a spin in your web socket-less browser.</p>

<h3>Injecting data into web sockets is easy</h3>

<p>Since I needed to send cursor locations on <code>mousemove()</code>, I had to create a connection to the web socket using Javascipt. This made it quite easy to send anything you want by injecting some Javascript into the page and calling <code>conn.send</code>. The web socket server would simply broadcast it to the other clients.</p>

<p>I was amazed to see <a href="http://twitter.com/einaros" title="Einar Otto Stangvik">@einaros</a> took the time to inject multiple cursors into the page and rotate them in 3D space. He even made <a href="http://www.youtube.com/watch?v=jULOA7mSOac">a video</a>.</p>

<p>How would we prevent users from doing something like this? I haven&#8217;t come up with a solution yet, since I think it&#8217;s impossible to find out if the messages get sent on <code>mousemove()</code> or if they&#8217;re simply called using a javascript console. I&#8217;d love to hear your thoughts on this.</p>

<h3>I should have sanitized the messages</h3>

<p>Although I ignored evil messages on the client side &#8212; I checked if the &#8220;action&#8221; was &#8220;move&#8221; or &#8220;close&#8221; &#8212; the Node.js server would still broadcast any <span class="caps">JSON</span> message it received. That meant injecting something like this would result in it being sent to every other client:</p>

<div class="highlight">
<pre><code class="javascript">  <span class="nx">conn</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="s1">'injected!'</span><span class="o">:</span> <span class="s1">'haha!'</span><span class="p">});</span>
</code></pre>
</div>

<p>Again, nothing would happen if a client would receive this message because it wouldn&#8217;t contain anything it would understand. Still, not very nice to just broadcast this to everyone.</p>

<p>Right now, the message listener catches syntax errors when trying to parse the message and checks if the action is &#8220;close&#8221; or &#8220;move&#8221;:</p>

<div class="highlight">
<pre><code class="javascript"><span class="nx">server</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">"connection"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn</span><span class="p">){</span>
  <span class="nx">conn</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">"message"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
    
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">request</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">SyntaxError</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="s1">'Invalid JSON:'</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">action</span> <span class="o">!=</span> <span class="s1">'close'</span> <span class="o">&amp;&amp;</span> <span class="nx">request</span><span class="p">.</span><span class="nx">action</span> <span class="o">!=</span> <span class="s1">'move'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">(</span><span class="s1">'Ivalid request:'</span><span class="p">);</span>
      <span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nx">request</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">request</span><span class="p">));</span>    
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<h3>More?</h3>

<p>If you have any more feedback on the code sample, be sure to let me know. <a href="http://gist.github.com/488562">The gist</a> is updated and be sure to check out the <a href="http://jeffkreeftmeijer.com/2010/experimenting-with-node-js/">new and improved version of the experiment</a>.</p>

</div>

  </div>

  <div id="ads">
    <div class="ad">
      <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=jeffkreeftmeijercom" id="_carbonads_js"></script>
    </div>
  </div>

  <script type="text/javascript" async="true" id="gauges-tracker" data-site-id="4d62819ef0d8804188000010" src="http://secure.gaug.es/track.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-12888762-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
