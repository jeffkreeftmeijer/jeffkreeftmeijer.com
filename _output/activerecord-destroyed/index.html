<!DOCTYPE html>
<meta charset="utf-8"/>
<title>Jeff Kreeftmeijer</title>
<meta name="viewport" content="initial-scale=1, user-scalable=yes">
<meta name="description" content="Jeff Kreeftmeijer is an Elixir/Ruby programmer, writing code for AppSignal.">
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
<style>body{font:18px/1.4 -apple-system,sans-serif;margin:auto;max-width:40em;padding:1em}h1,h2,h3,h4,h5,h6{line-height:normal}img{max-width:100%}code{font:0.8em Monaco,monospace}pre{background-color:ghostwhite;overflow-x:auto;padding:1em}
aside{position:absolute;top:2.34em;left:50%;width:50%;overflow:hidden;z-index:-100}aside div{margin-left:22em;width:130px}aside a{text-decoration:none;color:slategray;font-size:0.7em;display:block;margin-bottom:1em}aside .carbon-poweredby{font-style:italic}</style>

<h1>Checking if an ActiveRecord model instance was destroyed</h1>
<p><time>2014-09-11</time></p>
<p><a href="https://github.com/rails/rails/commit/7034272354ad41dd4d1c90138a79e7f14ebc2bed#diff-391caa9b9464021e932ebf657fa9b13cR2496"><code class="inline">ActiveRecord::Base#destroyed?</code></a> was introduced in 2009, about a year before Rails 3.0 was released. Still, almost five years later, I regularly see code that tests a destroy action by querying the database after deleting the record to see if it still exists:</p>
<pre><code class="ruby">delete :destroy
Session.exist?(@session).should.be.false

# or:

lambda {
  delete :destroy
}.should.change(&#39;Session.count&#39; -1)

# or even:

delete :destroy
lambda {
  @session.reload 
}.should.raise(ActiveRecord::RecordNotFound)</code></pre>
<p>By using <code class="inline">ActiveRecord::Base#destroyed?</code>, you can ask ActiveRecord if <code class="inline">#delete</code> or <code class="inline">#destroy</code> was called on that specific object, without having to check the database:</p>
<pre><code class="">describe SessionsController do
  before do
    @session = sessions(:harry)
    cookies[:authorization] = @session.token
  end

  it &quot;logs the user out&quot; do
    delete :destroy
    assigns(:session).should.be.destroyed
  end
end</code></pre>
<p>Be sure to test this on the same instance you called <code class="inline">#delete</code> or <code class="inline">#destroy</code> on, though. Calling <code class="inline">#destroyed?</code> on <code class="inline">@session</code> instead of <code class="inline">assigns(:session)</code> in the above example would return <code class="inline">false</code>. Thatâ€™s because <code class="inline">#destroy</code> and <code class="inline">#delete</code> actually set a <code class="inline">@destroyed</code> flag on the object, which is returned when you call <code class="inline">#destroyed?</code>.</p>

<hr/>
<nav style="display: flex;justify-content: space-between">
  
    <a href="/" rel="author">Jeff Kreeftmeijer</a>
  
  <a href="/archive/">Archive</a>
  <a href="https://twitter.com/jkreeftmeijer">Twitter</a>
  <a href="https://github.com/jeffkreeftmeijer">Github</a>
  <a href="/feed.xml">RSS</a>
</nav>

<aside>
  <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=jeffkreeftmeijercom" id="_carbonads_js"></script>
</aside>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-12888762-1', 'auto');
  ga('send', 'pageview');
</script>
